
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HSK 1–2 Flashcards (Offline)</title>
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="HSK Flashcards">
  <link rel="apple-touch-icon" href="icon-512.png">
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--btn:#1f2937;--card:#0b1220;--shadow:0 6px 24px rgba(0,0,0,.35);--radius:14px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:radial-gradient(1200px 800px at 70% -10%,#1e293b 0%,var(--bg) 60%);color:var(--text)}
    header{padding:20px 16px 8px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
    header h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px}
    main{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:920px){.grid{grid-template-columns:1.2fr .8fr}}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .section{padding:16px 18px} .section h2{margin:0 0 8px;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=file],select,button,input[type=number],.pill{background:var(--btn);color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;font-size:14px}
    input[type=number]{width:90px}
    button{cursor:pointer;transition:.15s transform,.15s background} button:hover{transform:translateY(-1px)}
    button.primary{background:linear-gradient(180deg,#16a34a,#17863f);border-color:#107a37}
    button.secondary{background:#1e293b} button.warn{background:#3b2f0b;border-color:#4d3a0b;color:#facc15} button.ghost{background:transparent;border-color:rgba(255,255,255,.12);color:var(--muted)}
    textarea{width:100%;min-height:120px;resize:vertical;background:#0b1020;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;font-size:13px;font-family:ui-monospace,Menlo,Consolas,monospace}
    .card{margin:18px;border-radius:var(--radius);background:linear-gradient(180deg,#0b1220,#0a1020);min-height:220px;display:flex;align-items:center;justify-content:center;text-align:center;padding:24px;border:1px solid rgba(255,255,255,.08)}
    .big{font-size:40px;line-height:1.15} .small{font-size:17px;color:var(--muted);margin-top:8px} .meta{font-size:13px;color:var(--muted);margin-top:8px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:0 18px 18px}
    .stats{display:flex;gap:12px;flex-wrap:wrap;margin:0 18px 18px;color:var(--muted);font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>HSK 1–2 Flashcards <span class="sub">— offline, preloaded</span></h1>
      <div class="sub">Tap “Load Preloaded HSK” to start. You can also paste or import your own CSV/TSV.</div>
    </div>
    <div class="row">
      <span class="pill"><b>Flip</b>: <span id="modeLabel">Hanzi → English</span></span>
      <span class="pill">Cards/Session: <span id="sessLabel">15</span></span>
      <span class="pill">Queue: <span id="queueCount">0</span></span>
    </div>
  </header>

  <main class="grid">
    <section class="panel">
      <div class="section">
        <h2>Deck & Options</h2>
        <div class="row" style="margin-bottom:6px">
          <button class="primary" id="loadHSK">Load Preloaded HSK 1–2</button>
          <div class="pill">~50 starter words (add your own anytime)</div>
        </div>
        <div class="row">
          <label>Or load a file</label>
          <input id="file" type="file" accept=".csv,.tsv,.txt">
        </div>
        <div class="row" style="margin-top:8px">
          <label>Or paste list (headers: <code>hanzi,pinyin,english,level</code>)</label>
        </div>
        <textarea id="paste" placeholder="hanzi,pinyin,english,level&#10;你好,ni3 hao3,hello,HSK1"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="secondary" id="usePasted">Use Pasted Deck</button>
          <button class="ghost" id="clearPasted">Clear</button>
          <div style="flex:1"></div>
          <label>Flip</label>
          <select id="mode">
            <option value="hz2en">Hanzi → English (default)</option>
            <option value="en2hz">English → Hanzi</option>
            <option value="hz2py">Hanzi → Pinyin</option>
            <option value="py2hz">Pinyin → Hanzi</option>
          </select>
          <label>Cards / session</label>
          <input id="sess" type="number" min="5" max="100" step="1" value="15">
          <button class="secondary" id="start">Start Session</button>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="card" id="card">
        <div>
          <div class="big" id="front">Load Preloaded HSK or add a deck</div>
          <div class="small" id="back" style="display:none"></div>
          <div class="meta" id="meta"></div>
        </div>
      </div>
      <div class="controls">
        <button id="btnFlip">Flip (F)</button>
        <button class="secondary" id="btnNext">Next (Space/N)</button>
        <button class="primary" id="btnGot">Got it (G)</button>
        <button class="warn" id="btnMiss">Missed (M)</button>
      </div>
      <div class="stats">
        <div>Seen: <b id="seen">0</b></div>
        <div style="color:#22c55e">Correct: <b id="correct">0</b></div>
        <div style="color:#f87171">Missed: <b id="missed">0</b></div>
      </div>
    </section>
  </main>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function(){ navigator.serviceWorker.register('./sw.js').catch(function(){}); });
    }
  </script>
  <script>
    var deck = [], queue = [], ptr=0, flipped=false;
    var stats = {seen:0, correct:0, missed:0};
    var mode = localStorage.getItem('mode') || 'hz2en';
    var sessSize = parseInt(localStorage.getItem('sessSize')||'15',10);
    var frontEl = document.getElementById('front'), backEl=document.getElementById('back'), metaEl=document.getElementById('meta');

    // Preloaded data as JSON (robust, no CSV parsing)
    var PRELOADED = [{"hanzi": "你好", "pinyin": "ni3 hao3", "english": "hello", "level": "HSK1"}, {"hanzi": "谢谢", "pinyin": "xie4 xie", "english": "thanks", "level": "HSK1"}, {"hanzi": "请", "pinyin": "qing3", "english": "please", "level": "HSK1"}, {"hanzi": "对不起", "pinyin": "dui4 bu4 qi3", "english": "sorry", "level": "HSK1"}, {"hanzi": "没关系", "pinyin": "mei2 guan1 xi", "english": "no problem", "level": "HSK1"}, {"hanzi": "再见", "pinyin": "zai4 jian4", "english": "goodbye", "level": "HSK1"}, {"hanzi": "是", "pinyin": "shi4", "english": "to be", "level": "HSK1"}, {"hanzi": "不是", "pinyin": "bu2 shi4", "english": "not be", "level": "HSK1"}, {"hanzi": "要", "pinyin": "yao4", "english": "to want", "level": "HSK1"}, {"hanzi": "不要", "pinyin": "bu2 yao4", "english": "don't want", "level": "HSK1"}, {"hanzi": "有", "pinyin": "you3", "english": "to have", "level": "HSK1"}, {"hanzi": "没有", "pinyin": "mei2 you3", "english": "don't have", "level": "HSK1"}, {"hanzi": "吃", "pinyin": "chi1", "english": "to eat", "level": "HSK1"}, {"hanzi": "喝", "pinyin": "he1", "english": "to drink", "level": "HSK1"}, {"hanzi": "水", "pinyin": "shui3", "english": "water", "level": "HSK1"}, {"hanzi": "米饭", "pinyin": "mi3 fan4", "english": "rice", "level": "HSK1"}, {"hanzi": "多少", "pinyin": "duo1 shao3", "english": "how much / how many", "level": "HSK1"}, {"hanzi": "这", "pinyin": "zhe4", "english": "this", "level": "HSK1"}, {"hanzi": "那", "pinyin": "na4", "english": "that", "level": "HSK1"}, {"hanzi": "哪里", "pinyin": "na3 li3", "english": "where", "level": "HSK1"}, {"hanzi": "今天", "pinyin": "jin1 tian1", "english": "today", "level": "HSK1"}, {"hanzi": "昨天", "pinyin": "zuo2 tian1", "english": "yesterday", "level": "HSK1"}, {"hanzi": "明天", "pinyin": "ming2 tian1", "english": "tomorrow", "level": "HSK1"}, {"hanzi": "现在", "pinyin": "xian4 zai4", "english": "now", "level": "HSK1"}, {"hanzi": "点", "pinyin": "dian3", "english": "o'clock", "level": "HSK1"}, {"hanzi": "分钟", "pinyin": "fen1 zhong1", "english": "minute", "level": "HSK1"}, {"hanzi": "晚上", "pinyin": "wan3 shang4", "english": "evening", "level": "HSK1"}, {"hanzi": "星期", "pinyin": "xing1 qi1", "english": "week", "level": "HSK1"}, {"hanzi": "名字", "pinyin": "ming2 zi", "english": "name", "level": "HSK1"}, {"hanzi": "朋友", "pinyin": "peng2 you", "english": "friend", "level": "HSK1"}, {"hanzi": "家", "pinyin": "jia1", "english": "home/family", "level": "HSK1"}, {"hanzi": "老师", "pinyin": "lao3 shi1", "english": "teacher", "level": "HSK1"}, {"hanzi": "学生", "pinyin": "xue2 sheng1", "english": "student", "level": "HSK1"}, {"hanzi": "医生", "pinyin": "yi1 sheng1", "english": "doctor", "level": "HSK1"}, {"hanzi": "喜欢", "pinyin": "xi3 huan1", "english": "to like", "level": "HSK1"}, {"hanzi": "想", "pinyin": "xiang3", "english": "to want / think", "level": "HSK1"}, {"hanzi": "会", "pinyin": "hui4", "english": "can / know how", "level": "HSK1"}, {"hanzi": "可以", "pinyin": "ke3 yi3", "english": "may / can", "level": "HSK1"}, {"hanzi": "去", "pinyin": "qu4", "english": "to go", "level": "HSK1"}, {"hanzi": "来", "pinyin": "lai2", "english": "to come", "level": "HSK1"}, {"hanzi": "住", "pinyin": "zhu4", "english": "to live", "level": "HSK1"}, {"hanzi": "走", "pinyin": "zou3", "english": "to walk", "level": "HSK1"}, {"hanzi": "看", "pinyin": "kan4", "english": "to look / read", "level": "HSK1"}, {"hanzi": "听", "pinyin": "ting1", "english": "to listen", "level": "HSK1"}, {"hanzi": "说话", "pinyin": "shuo1 hua4", "english": "to speak", "level": "HSK1"}, {"hanzi": "问", "pinyin": "wen4", "english": "to ask", "level": "HSK1"}, {"hanzi": "认识", "pinyin": "ren4 shi", "english": "to know (someone)", "level": "HSK1"}];

    function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
    function buildQueue(size){ var idxs = deck.map(function(_,i){return i;}); shuffle(idxs); queue = idxs.slice(0, Math.min(size, idxs.length)); ptr=0; document.getElementById('queueCount').textContent = queue.length; }
    function renderSides(card){
      var front='', back='', meta='';
      if(mode==='hz2en'){ front=card.hanzi||card.pinyin||'—'; back=card.english||''; meta=card.pinyin; }
      if(mode==='en2hz'){ front=card.english||'—'; back=card.hanzi||card.pinyin||''; meta=card.pinyin; }
      if(mode==='hz2py'){ front=card.hanzi||'—'; back=card.pinyin||''; meta=card.english; }
      if(mode==='py2hz'){ front=card.pinyin||'—'; back=card.hanzi||''; meta=card.english; }
      return {front:front, back:back, meta:(card.level? card.level+' • ' : '') + (meta||'')};
    }
    function showCard(){
      if(queue.length===0){ frontEl.textContent='Load Preloaded HSK or add a deck'; backEl.style.display='none'; metaEl.textContent=''; return; }
      if(ptr>=queue.length){
        frontEl.innerHTML='Session complete 🎉';
        backEl.style.display='block';
        backEl.innerHTML='<span style="color:#22c55e">Correct: '+stats.correct+'</span> • <span style="color:#f87171">Missed: '+stats.missed+'</span>';
        metaEl.textContent='Tap Start Session to go again'; return;
      }
      var card = deck[ queue[ptr] ]; var r = renderSides(card);
      frontEl.textContent=r.front; backEl.textContent=r.back; backEl.style.display = flipped ? 'block':'none'; metaEl.textContent=r.meta;
    }
    function flip(){ flipped=!flipped; backEl.style.display = flipped ? 'block':'none'; }
    function next(){ if(ptr<queue.length){ ptr++; } flipped=false; showCard(); }
    function got(){ if(ptr>=queue.length) return; stats.seen++; stats.correct++; document.getElementById('seen').textContent=stats.seen; document.getElementById('correct').textContent=stats.correct; queue.splice(ptr,1); document.getElementById('queueCount').textContent=queue.length; flipped=false; showCard(); }
    function miss(){ if(ptr>=queue.length) return; stats.seen++; stats.missed++; document.getElementById('seen').textContent=stats.seen; document.getElementById('missed').textContent=stats.missed; var cur = queue[ptr]; queue.splice(ptr,1); var re = Math.min(queue.length, ptr + 5 + Math.floor(Math.random()*3)); queue.splice(re,0,cur); document.getElementById('queueCount').textContent=queue.length; flipped=false; showCard(); }

    document.getElementById('loadHSK').addEventListener('click', function(){
      deck = PRELOADED.slice();
      stats = {seen:0,correct:0,missed:0};
      var s = parseInt(document.getElementById('sess').value, 10); if(isNaN(s)) s = 15;
      buildQueue(Math.max(5, Math.min(100, s)));
      flipped=false; showCard();
    });

    // Optional CSV/TSV support kept for flexibility
    function parseCSV(text){
      var delim = text.indexOf('\t')>-1 ? '\t' : ',';
      var lines = text.split(/\r?\n/).filter(function(l){return l.trim().length>0;});
      if(lines.length===0) return [];
      var headers = lines[0].split(delim).map(function(h){return h.trim().toLowerCase();});
      var idx = {hanzi:headers.indexOf('hanzi'), pinyin:headers.indexOf('pinyin'), english:headers.indexOf('english'), level:headers.indexOf('level')};
      var out=[], i;
      for(i=1;i<lines.length;i++){
        var cols = splitSmart(lines[i], delim);
        out.push({
          hanzi: idx.hanzi>=0 ? (cols[idx.hanzi]||'').trim() : '',
          pinyin: idx.pinyin>=0 ? (cols[idx.pinyin]||'').trim() : '',
          english: idx.english>=0 ? (cols[idx.english]||'').trim() : '',
          level: idx.level>=0 ? (cols[idx.level]||'').trim() : ''
        });
      }
      return out.filter(function(r){ return r.hanzi||r.english||r.pinyin; });
    }
    function splitSmart(line, delim){
      var out=[], cur='', inQ=false, i, ch, nxt;
      for(i=0;i<line.length;i++){
        ch=line[i]; nxt=line[i+1];
        if(ch==='"'){
          if(inQ && nxt==='"'){ cur+='"'; i++; }
          else { inQ=!inQ; }
        }else if(ch===delim && !inQ){ out.push(cur); cur=''; }
        else cur+=ch;
      }
      out.push(cur); return out;
    }
    document.getElementById('file').addEventListener('change', function(e){
      var f=e.target.files[0]; if(!f) return;
      f.text().then(function(text){
        var parsed = parseCSV(text);
        if(parsed.length===0) return alert('Could not parse any rows. Ensure headers: hanzi,pinyin,english,level');
        deck=parsed; stats={seen:0,correct:0,missed:0}; var s2 = parseInt(document.getElementById('sess').value, 10); if(isNaN(s2)) s2 = 15; buildQueue(s2); flipped=false; showCard();
      });
    });
    document.getElementById('usePasted').addEventListener('click', function(){
      var text = document.getElementById('paste').value.trim();
      if(!text) return alert('Paste CSV/TSV first.');
      var parsed = parseCSV(text);
      if(parsed.length===0) return alert('No rows parsed; check headers.');
      deck=parsed; stats={seen:0,correct:0,missed:0}; var s2 = parseInt(document.getElementById('sess').value, 10); if(isNaN(s2)) s2 = 15; buildQueue(s2); flipped=false; showCard();
    });
    document.getElementById('clearPasted').addEventListener('click', function(){ document.getElementById('paste').value=''; });

    document.getElementById('mode').value = mode;
    document.getElementById('sess').value = sessSize;
    document.getElementById('sessLabel').textContent = sessSize;
    document.addEventListener('keydown', function(e){
      if(e.repeat) return; var k=e.key.toLowerCase();
      if(k==='f') flip(); else if(k==='g') got(); else if(k==='m') miss(); else if(k==='n'||k===' ') { next(); e.preventDefault(); }
    });
  </script>
</body>
</html>
